<!DOCTYPE html>
<meta charset="utf-8">
<!-- Apply specific style to the elements that have the class `inGreen` -->
<style>
    .rightNext {
        display: inline-block;
        margin: 0;
        position: absolute;
        top: 95%;
        left: 95%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        background-color: #0004ff;
        color: blue;
        box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
        transition: all 0.5s;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        border-radius: 5px;
        border: none;
    }
    
    .rightNext:hover {
        background-color: red;
    }
    
    .rightNext:active {
        background-color: #3e8e41;
        box-shadow: 5px 5px #666;
        transform: translateX(10px);
    }
    
    .leftPrev {
        display: inline-block;
        margin: 0;
        position: absolute;
        top: 95%;
        left: 5%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        background-color: #0004ff;
        color: blue;
        box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
        transition: all 0.5s;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        border-radius: 5px;
        border: none;
    }
    
    .leftPrev:hover {
        background-color: red;
    }
    
    .leftPrev:active {
        background-color: #3e8e41;
        box-shadow: 5px 5px #666;
        transform: translateX(-50px);
    }
    
    .centerHome {
        display: inline-block;
        margin: 0;
        position: absolute;
        top: 95%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        background-color: #0004ff;
        color: blue;
        box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
        transition: all 0.5s;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        border-radius: 5px;
        border: none;
    }
    
    .centerHome:hover {
        background-color: red;
    }
    
    .centerHome:active {
        background-color: #3e8e41;
        box-shadow: 5px 5px #666;
        transform: translateX(-50px);
    }
    
    .tooltip {
        opacity: 0;
        position: absolute;
        top: -14px;
        left: 10px;
        padding: 0.6em 1em;
        background: #fff;
        text-align: left;
        line-height: 1.4em;
        font-size: 0.9em;
        border: 1px solid #ddd;
        z-index: 10;
        transition: all 0.1s ease-out;
        pointer-events: none;
    }
</style>

<head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <!-- Load d3-annotation -->
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
    <title>Does Electricity impact CO2 emission</title>
</head>
<div id="top">

    <body style="background-color:powderblue;padding:0px 5px;">
        <h1 style="text-align:center;color:blue;font-size:40px;">Fossil fuel based electricity production vs CO2 emmisions in 2014</h1>
        <p>The second scene, the scatter plot below is an attempt to understand if there is a correlation between the extent of fossil fuel driven electricity production and the overall Carbon Dioxide emissions on a country basis.
        </p>
        <p style="text-align:center"><i>Hint :</i> Hover over a point to see more details</p>

        <!-- Create a div where the graph will take place -->
        <div id="my_dataviz"></div>

        <script>
            // set the dimensions and margins of the graph
            const margin = {
                    top: 10,
                    right: 30,
                    bottom: 130,
                    left: 100
                },
                width = 1000 - margin.left - margin.right,
                //width = document.body.offsetWidth / 2 + margin.left,
                height = 500 - margin.top - margin.bottom;
            console.log(width)

            // append the svg object to the body of the page
            const svg = d3.select("#my_dataviz")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    `translate(${margin.left}, ${margin.top})`);

            //Read the data
            d3.csv("https://raw.githubusercontent.com/SahaniGoonetilleke/ABC/master/ScatterCO2.csv").then(function(data) {
                // Add X axis
                const x = d3.scaleLinear()
                    .domain([0, 0])
                    .range([0, width]);
                svg.append("g")
                    .attr("class", "myXaxis") // Note that here we give a class to the X axis, to be able to call it later and modify it
                    .attr("transform", `translate(0, ${height})`)
                    .call(d3.axisBottom(x))
                    .attr("opacity", "0");

                // Add Y axis
                const y = d3.scaleLinear()
                    .domain([0, 100])
                    .range([height, 0]);
                svg.append("g")
                    .call(d3.axisLeft(y));



                // label axes
                const xlabel = svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -30)
                    .attr("x", -170)
                    .attr("font-size", 12)
                    .attr("font-family", "sans-serif")
                    .attr("text-anchor", "middle")
                    .text("Electricity production from oil, gas and coal sources (% of total)")
                const ylabel = svg.append("text")
                    //.attr("transform", "rotate(-90)")
                    .attr("y", 388)
                    .attr("x", width - 180)
                    .attr("font-size", 12)
                    .attr("font-family", "sans-serif")
                    .attr("text-anchor", "middle")
                    .text("CO2 emissions (metric tons per capita)")

                // Color scale: give me a specie name, I return a color
                const color = d3.scaleOrdinal()
                    .domain(["C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8"])
                    //.range(["#440154ff", "#21908dff", "#fde725ff"])
                    .range(["#1a9850", "#66bd63", "#a6d96a", "#d9ef8b", "#fee08b", "#fdae61", "#f46d43", "#d73027"])

                // Annotations
                const type = d3.annotationLabel

                const annotations = [{
                    note: {
                        label: "High in all criteria.\nCO2 emissions is 43.523 metric tons per capita, Electricity production from fossil fuels is 100% and CO2 emissions from electricity and heat productions is 63.54% of total fuel combustion.",
                        bgPadding: 10,
                        title: "Qatar"
                    },
                    x: 960,
                    y: 10,
                    className: "show-bg",
                    dy: 25,
                    dx: -100
                }]

                const makeAnnotations = d3.annotation()
                    .editMode(true)
                    //also can set and override in the note.padding property
                    //of the annotation object
                    .notePadding(15)
                    .type(type)
                    //accessors & accessorsInverse not needed
                    //if using x, y in annotations JSON
                    .accessors({
                        x: d => x(parseTime(d.CO2Emissions2014)),
                        y: d => y(d.production2014)
                    })
                    .accessorsInverse({
                        date: d => timeFormat(x.invert(d.x)),
                        close: d => y.invert(d.y)
                    })
                    .annotations(annotations)
                d3.select("svg")
                    .append("g")
                    .attr("class", "annotation-group")
                    .call(makeAnnotations)

                //End of annotations


                // Tooltip code

                // Add a tooltip div. Here I define the general feature of the tooltip: stuff that do not depend on the data point.
                // Its opacity is set to 0: we don't see it by default.
                const tooltip = d3.select("#my_dataviz")
                    .append("div")
                    .style("opacity", 0)
                    .attr("class", "tooltip")
                    .style("background-color", "white")
                    .style("border", "solid")
                    .style("border-width", "1px")
                    .style("border-radius", "5px")
                    .style("padding", "10px")

                // A function that change this tooltip when the user hover a point.
                // Its opacity is set to 1: we can now see it. Plus it set the text and position of tooltip depending on the datapoint (d)
                const mouseover = function(event, d) {
                    tooltip
                        .style("opacity", 1)
                        .style("background-color", function(d) {
                            return color(d.countryColor)
                        })
                }

                const mousemove = function(event, d) {
                    tooltip
                        .html(`<b>Country :</b> ${d['Country Name']} <br><b>Year :</b> 2014<br><b>CO2 emissions : </b>${d.CO2Emissions2014} metric tons per capita
                <br><b>Electricity production from oil, gas and coal sources as a % of total :</b>
                <br>    ${d.production2014}%
                <br><b>CO2 emissions from electricity and heat production, total as a % of total fuel combustion :</b>
                <br>    ${d.CO2Electperc2014}%`)
                        .style("left", (event.x) / 2 + 90 + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
                        .style("top", (event.y) / 2 + "px")
                        .style("background-color", function(d) {
                            return color(d.countryColor)
                        });
                }

                // A function that change this tooltip when the leaves a point: just need to set opacity to 0 again
                const mouseleave = function(event, d) {
                    tooltip
                        .transition()
                        .duration(200)
                        .style("opacity", 0)
                }

                // Add dots before added animation
                /*svg.append('g')
                    .selectAll("dot")
                    .data(data)
                    .join("circle")
                    .attr("cx", function(d) {
                        return x(d.CO2Emissions2014);
                    })
                    .attr("cy", function(d) {
                        return y(d.production2014);
                    })
                    .attr("r", 5)
                    .style("fill", function(d) {
                        return color(d.countryColor)
                    })*/

                // Add dots for with animation
                svg.append('g')
                    .selectAll("dot")
                    //.data(data)
                    .data(data.filter(function(d, i) {
                        return i < 300
                    })) // the .filter part is just to keep a few dots on the chart, not all of them
                    .enter()
                    .append("circle")
                    .attr("cx", function(d) {
                        return x(d.CO2Emissions2014);
                    })
                    .attr("cy", function(d) {
                        return y(d.production2014);
                    })
                    .attr("r", 5)
                    .style("fill", function(d) {
                        return color(d.countryColor)
                    })
                    .style("opacity", 1)
                    .style("stroke", "white")
                    .on("mouseover", mouseover)
                    .on("mousemove", mousemove)
                    .on("mouseleave", mouseleave);


                // new X axis for animation at loading
                x.domain([0, 44])
                svg.select(".myXaxis")
                    .transition()
                    .duration(2000)
                    .attr("opacity", "1")
                    .call(d3.axisBottom(x));

                svg.selectAll("circle")
                    .transition()
                    .delay(function(d, i) {
                        return (i * 3)
                    })
                    .duration(2000)
                    .attr("cx", function(d) {
                        return x(d.CO2Emissions2014);
                    })
                    .attr("cy", function(d) {
                        return y(d.production2014);
                    })


            })


            //legend ;)


            //Legend code
            function legend({
                color,
                title,
                tickSize = 6,
                width = 400,
                height = 44 + tickSize,
                marginTop = 425,
                marginRight = 0,
                marginBottom = -393 + tickSize,
                marginLeft = 80,
                ticks = width / 64,
                tickFormat,
                tickValues
            } = {}) {
                const svg = d3.select("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [-50, 0, width, height])
                    .attr("border", 1)
                    .style("overflow", "visible")
                    .style("display", "block");

                let tickAdjust = g => g.selectAll(".tick line").attr("y1", marginTop + marginBottom - height);
                let x;

                // Threshold
                if (color.invertExtent) {
                    const thresholds = color.thresholds ? color.thresholds() // scaleQuantize
                        :
                        color.quantiles ? color.quantiles() // scaleQuantile
                        :
                        color.domain(); // scaleThreshold

                    const thresholdFormat = tickFormat === undefined ? d => d :
                        typeof tickFormat === "string" ? d3.format(tickFormat) :
                        tickFormat;

                    x = d3.scaleLinear()
                        .domain([-1, color.range().length - 1])
                        .rangeRound([marginLeft, width - marginRight]);

                    svg.append("g")
                        .selectAll("rect")
                        .data(color.range())
                        .join("rect")
                        .attr("x", (d, i) => x(i - 1))
                        .attr("y", marginTop)
                        .attr("width", (d, i) => x(i) - x(i - 1))
                        .attr("height", height - marginTop - marginBottom)
                        .attr("fill", d => d);

                    tickValues = d3.range(thresholds.length);
                    tickFormat = i => thresholdFormat(thresholds[i], i);
                }

                svg.append("g")
                    .attr("transform", `translate(0,${height - marginBottom})`)
                    .call(d3.axisBottom(x)
                        .ticks(ticks, typeof tickFormat === "string" ? tickFormat : undefined)
                        .tickFormat(typeof tickFormat === "function" ? tickFormat : undefined)
                        .tickSize(tickSize)
                        .tickValues(tickValues))
                    .call(tickAdjust)
                    .call(g => g.select(".domain").remove())
                    .call(g => g.append("text")
                        .attr("x", marginLeft)
                        .attr("y", marginTop + marginBottom - height - 6)
                        .attr("fill", "currentColor")
                        .attr("text-anchor", "start")
                        .attr("font-weight", "bold")
                        .text(title));
                return svg.node();
            }

            function ramp(color, n = 256) {
                var canvas = document.createElement('canvas');
                canvas.width = n;
                canvas.height = 1;
                const context = canvas.getContext("2d");
                for (let i = 0; i < n; ++i) {
                    context.fillStyle = color(i / (n - 1));
                    context.fillRect(i, 0, 1, 1);
                }
                return canvas;
            }

            legend({
                //color: d3.scaleSequential([60000, 0], d3.interpolateRdYlGn),
                color: d3.scaleThreshold([100, 500, 1000, 2500, 5000, 10000, 30000, 60000], d3.schemeRdYlGn[8].reverse()),
                title: "Color Legend of Electric power consumption in kWh per capita"
            })

            // End of Legend Code
            // Start annotations for Eco-electric
            const type = d3.annotationXYThreshold

            const annotations = [{
                note: {
                    label: "Iceland, Norway and Sweden are below this line! (<5% fossil fuel)",
                    title: "Eco-electric!"
                },
                //can use x, y directly instead of data
                x: 300,
                y: 350,
                dy: -0.5,
                dx: 200,
                subject: {
                    x1: 50,
                    x2: 400
                }
            }]

            //const parseTime = d3.timeParse("%d-%b-%y")
            //const timeFormat = d3.timeFormat("%d-%b-%y")

            //Skipping setting domains
            //const x = d3.scaleTime().range([0, 800])
            //const y = d3.scaleLinear().range([300, 0])

            const makeAnnotations = d3.annotation()
                .editMode(true)
                //also can set and override in the note.padding property
                //of the annotation object
                .notePadding(15)
                .type(type)
                //accessors & accessorsInverse not needed
                //if using x, y in annotations JSON
                //.accessors({
                //    x: d => x(parseTime(d.Year)),
                //    y: d => y(d.close)
                //})
                //.accessorsInverse({
                //    date: d => timeFormat(x.invert(d.x)),
                //    close: d => y.invert(d.y)
                //})
                .annotations(annotations)

            d3.select("svg")
                .append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations)

            // End annotations for Eco-electric
        </script>

    </body>
</div>

<div class="rightNext ">
    <form method="get " action="./scatterSummary.html ">
        <button type="submit " style="color:white;background-color: blue;font-size:large;padding: 15%; ">Next</button>
    </form>
</div>
<div class="leftPrev ">
    <form method="get " action="./map1990.html ">
        <button type="submit " style="color:white;background-color: blue;font-size:large;padding: 15%; ">Prev</button>
    </form>
</div>
<div class="centerHome ">
    <form method="get " action="./index.html ">
        <button type="submit " style="color:white;background-color: blue;font-size:small;padding: 5%; ">&#127968;Home</button>
    </form>
</div>

</html>